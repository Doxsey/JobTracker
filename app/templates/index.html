{% from "jobs_macros.html" import job_row_with_activities, job_row_without_activities, job_row_with_additional_info %}
{% from "pagination_macro.html" import render_pagination, render_per_page_selector %}
{% extends "base.html" %}
{% block title %}Home - Job Tracker{% endblock %}
{% block content %}
<div class="row">
  <div class="col-md-12">
    <p class="lead">{{ title }}</p>

    <!-- Per-page selector -->
    {% if pagination %}
    {{ render_per_page_selector(pagination, request.endpoint) }}
    {% endif %}

    {% if jobs %}
    <table class="table table-hover">
      <thead>
        <tr>
          <th></th>
          <th>Company</th>
          <th>Job Title</th>
          <th>Location</th>
          <th>Remote Option</th>
          <th>Salary Range</th>
          <th>Date Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for job in jobs %}
        {% set has_activities = job.activities|length > 0 %}
        {% set has_notes = job.notes|length > 0 %}
        {% set has_files = job.resume_file or job.job_description_file or job.cover_letter_file %}
        {% if has_activities or has_notes or has_files%}
        {{ job_row_with_additional_info(job) }}
        {% else %}
        {{ job_row_without_activities(job) }}
        {% endif %}
        {% endfor %}
      </tbody>
    </table>

    <!-- Pagination controls -->
    {% if pagination %}
    {{ render_pagination(pagination, request.endpoint) }}
    {% endif %}

    {% else %}
    <div class="alert alert-info" role="alert">
      <h4 class="alert-heading">No jobs found</h4>
      <p>There are no job applications to display.</p>
    </div>
    {% endif %}

    <div class="mt-4">
      <a href="{{ url_for('jobs.create') }}" class="btn btn-success">Add Job Application</a>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Handle dropdown clicks to prevent row expansion
    document.addEventListener("click", function (e) {
      // If click is within dropdown, stop propagation
      if (e.target.closest(".dropdown")) {
        e.stopPropagation();
        // Handle dropdown item clicks
        if (e.target.classList.contains("dropdown-item")) {
          const href = e.target.getAttribute("data-href");
          if (href) {
            window.location.href = href;
          }
        }
        return;
      }
      // Handle row clicks for expansion
      const clickableRow = e.target.closest(".clickable-row");
      if (clickableRow) {
        const targetId = clickableRow.getAttribute("data-bs-target");
        const target = document.querySelector(targetId);
        if (target) {
          const bsCollapse = new bootstrap.Collapse(target, { toggle: true });
        }
      }
    });
    // Handle main row collapse icons
    const collapsibleRows = document.querySelectorAll('[data-bs-toggle="collapse"]:not(.sub-detail-btn)');
    collapsibleRows.forEach(function (row) {
      const targetId = row.getAttribute("data-bs-target");
      const target = document.querySelector(targetId);
      const icon = row.querySelector(".expand-icon");
      target.addEventListener("shown.bs.collapse", function () {
        row.classList.remove("collapsed");
      });
      target.addEventListener("hidden.bs.collapse", function () {
        row.classList.add("collapsed");
      });
      // Initialize collapsed state
      row.classList.add("collapsed");
    });
    // Handle nested collapse icons
    const nestedButtons = document.querySelectorAll(".sub-detail-btn");
    nestedButtons.forEach(function (button) {
      const targetId = button.getAttribute("data-bs-target");
      const target = document.querySelector(targetId);
      const icon = button.querySelector(".nested-expand-icon");
      target.addEventListener("shown.bs.collapse", function () {
        button.classList.remove("collapsed");
      });
      target.addEventListener("hidden.bs.collapse", function () {
        button.classList.add("collapsed");
      });
      // Initialize collapsed state
      button.classList.add("collapsed");
    });
  });
</script>
{% endblock %}